name: Render Tropical Mermaid Diagrams

on:
  push:
    paths:
      - 'docs/infra/**/*.mmd'
  workflow_dispatch:

jobs:
  render:
    runs-on: ubuntu-latest
    steps:
      # 1Ô∏è‚É£  Check out the repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£  Install Node and Mermaid CLI (v10.9.1)
      - name: Install Mermaid CLI
        run: |
          npm install -g @mermaid-js/mermaid-cli@10.9.1
          mmdc --version

      # 3Ô∏è‚É£  Create the output folder
      - name: Create output folder
        run: mkdir -p docs/infra/out

      # 4Ô∏è‚É£  Render all Mermaid diagrams (Chromium launched with --no-sandbox)
      - name: Render diagrams
        env:
          PUPPETEER_EXECUTABLE_PATH: ""   # let mmdc manage chromium
          PUPPETEER_ARGS: "--no-sandbox"  # üëà tells Puppeteer to launch chromium without sandbox
        run: |
          echo "Rendering Mermaid diagrams..."
          for f in docs/infra/*.mmd; do
            base=$(basename "$f" .mmd)
            echo "üñºÔ∏è  Rendering $f ‚Üí docs/infra/out/${base}.svg"
            mmdc -i "$f" \
                 -o "docs/infra/out/${base}.svg" \
                 -t default \
                 -b transparent \
                 -w 1600 -H 1000 \
                 --scale 2
          done
          echo "‚úÖ  All diagrams rendered!"

      # 5Ô∏è‚É£  Commit and push generated SVGs
      - name: Commit updated SVGs
        run: |
          git config --global user.name "Mermaid Bot"
          git config --global user.email "bot@digitalmonsters.com"
          git add docs/infra/out/*.svg || true
          git diff --cached --quiet && echo "No SVG changes to commit" || git commit -m "Auto-update Mermaid diagrams"
          git push || echo "No push (maybe running in PR or no changes)"
