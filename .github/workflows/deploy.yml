name: Deploy

on:
  push:
    branches:
      - master
      - staging

jobs:
  verify:
    name: 🚢 Deploy
    runs-on: ubuntu-latest
    steps:
      - name: 🌍 Setup Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 🔓 Login to Azure Container Registry
        uses: azure/docker-login@v1
        with:
          login-server: lititacr.azurecr.io
          username: ${{ secrets.AZURE_CONTAINER_REGISTRY_USERNAME }}
          password: ${{ secrets.AZURE_CONTAINER_REGISTRY_PASSWORD }}

      - name: 🐋 Build Docker Image
        run: make docker-image tag="${{ github.ref == 'refs/heads/master' && 'master' || 'stage' }}-$(git rev-parse --short HEAD)" github_token="${{ secrets.GH_TOKEN }}"

      - name: 🚢 Deploy to Azure Container Registry
        run: make docker-push tag="${{ github.ref == 'refs/heads/master' && 'master' || 'stage' }}-$(git rev-parse --short HEAD)"
