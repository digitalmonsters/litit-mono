name: Deploy

on:
  push:
    branches:
      - master
      - staging
      - github-ci

env:
  ACR_LOGIN_SERVER: lititacr.azurecr.io
  KUBERNETES_CLUSTER: litit-aks
  IMAGE_TAG: ${{ github.ref == 'refs/heads/master' && 'master' || 'stage' }}-${{ github.sha }}
  CONTAINER_IMAGE: ${{ env.ACR_LOGIN_SERVER }}/configurator:${{ env.IMAGE_TAG }}

jobs:
  verify:
    name: üö¢ Deploy
    runs-on: ubuntu-latest
    steps:
      - name: üåç Setup Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üîì Login to Azure Container Registry
        uses: azure/docker-login@v1
        with:
          login-server: ${{ env.ACR_LOGIN_SERVER }}
          username: ${{ secrets.AZURE_CONTAINER_REGISTRY_USERNAME }}
          password: ${{ secrets.AZURE_CONTAINER_REGISTRY_PASSWORD }}

      - name: üêã Build Docker Image
        run: make docker-image tag="${{ env.IMAGE_TAG }}" github_token="${{ secrets.GH_TOKEN }}"

      - name: üö¢ Deploy to Azure Container Registry
        run: make docker-push tag="${{ env.IMAGE_TAG }}"
